<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><title>دمج بيانات الشبكة داخل HTML (محليًا)</title><style>  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f9;margin:0;padding:24px;color:#222}  .card{max-width:900px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:20px}  h1{font-size:20px;margin:0 0 8px}  p{color:#555;margin:0 0 14px}  .row{display:grid;grid-template-columns:1fr;gap:12px;margin:16px 0}  .box{border:1px dashed #cbd5e1;border-radius:12px;padding:14px;background:#f9fafb}  label{display:block;font-weight:600;margin-bottom:6px}  input[type="file"]{width:100%}  button{background:#0a7d5a;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}  button:disabled{background:#a7a7a7;cursor:not-allowed}  .muted{color:#666;font-size:13px}  .ok{color:#0a7d5a}  .err{color:#b00020}  pre{white-space:pre-wrap;word-break:break-word;background:#f3f4f6;border-radius:10px;padding:10px;border:1px solid #e5e7eb}</style><!-- SheetJS لقراءة الإكسل داخل المتصفح --><script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script></head><body>  <div class="card">    <h1>دمج بيانات الشبكة داخل HTML (بدون سيرفر)</h1>    <p class="muted">حمّل <b>index.html</b> الأصلي، وملف الإكسل (<b>.xlsx</b>)… هترجع لك صفحة <b>index_embedded.html</b> فيها كل البيانات مدمجة.</p>
    <div class="row">      <div class="box">        <label>ملف الصفحة (index.html):</label>        <input id="htmlInput" type="file" accept=".html,.htm" />      </div>      <div class="box">        <label>ملف الشبكة الطبية (Excel .xlsx):</label>        <input id="xlsxInput" type="file" accept=".xlsx" />        <div class="muted">لو فيه شيت باسم <code>network_data</code> هيُستخدم، غير كده هياخد أول شيت.</div>      </div>    </div>
    <button id="runBtn" disabled> أنشئ index_embedded.html للتنزيل</button>    <p id="status" class="muted"></p>    <div id="log"></div>  </div>
<script>const htmlInput = document.getElementById('htmlInput');const xlsxInput = document.getElementById('xlsxInput');const runBtn = document.getElementById('runBtn');const statusEl = document.getElementById('status');const logEl = document.getElementById('log');
let htmlFile, xlsxFile;htmlInput.addEventListener('change', e => { htmlFile = e.target.files[0]; checkReady(); });xlsxInput.addEventListener('change', e => { xlsxFile = e.target.files[0]; checkReady(); });
function checkReady(){ runBtn.disabled = !(htmlFile && xlsxFile); }
function cleanPhone(v){  if (v==null) return "";  let s = String(v).trim();  if (["nan","none","null","undefined"].includes(s.toLowerCase())) return "";  if (s.endsWith(".0")) s = s.slice(0,-2);  return s;}
function arrayBufferToBinaryString(buf){  let binary = "", bytes = new Uint8Array(buf);  const chunk = 0x8000;  for (let i=0;i<bytes.length;i+=chunk){    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));  }  return binary;}
runBtn.addEventListener('click', async () => {  try{    statusEl.textContent = " جاري القراءة والمعالجة…";    logEl.innerHTML = "";
    const [htmlText, wb] = await Promise.all([      htmlFile.text(),      (async ()=>{        const ab = await xlsxFile.arrayBuffer();        const data = arrayBufferToBinaryString(ab);        return XLSX.read(data, {type:"binary"});      })()    ]);
    // اختيار الشيت    let sheetName = wb.SheetNames.includes("network_data") ? "network_data" : wb.SheetNames[0];    const ws = wb.Sheets[sheetName];    if (!ws) throw new Error("Sheet not found.");
    // تحويل إلى JSON صفوف (header: 1) ثم نطابق الأعمدة العربية    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});    if (!rows.length) throw new Error("الملف فارغ.");    const headers = rows[0].map(h=> String(h||"").trim());    const idx = name => headers.indexOf(name);
    const nameHeader = headers.includes("اسم مقدم الخدمة") ? "اسم مقدم الخدمة"                     : headers.includes("مقدم الخدمة") ? "مقدم الخدمة" : null;    if (!nameHeader) throw new Error("لم يتم العثور على عمود الاسم (اسم مقدم الخدمة/مقدم الخدمة).");
    const map = {      "المنطقة": "governorate",      "التخصص الرئيسي": "provider_type",      "التخصص الفرعي": "specialty_sub",      [nameHeader]: "name",      "عنوان مقدم الخدمة": "address"    };    const telKeys = ["Telephone1","Telephone2","Telephone3","Telephone4"];    const hotKey = "Hotline";
    const hIdx = {};    for (const k of Object.keys(map)) hIdx[k] = idx(k);    const telIdx = telKeys.map(k => idx(k));    const hotIdx = idx(hotKey);
    const records = [];    for (let r=1;r<rows.length;r++){      const row = rows[r] || [];      const get = (i)=> (i>=0 && row[i]!=null) ? String(row[i]).trim() : "";      const gov = get(hIdx["المنطقة"]);      const nm  = get(hIdx[nameHeader]);      if (!gov || !nm) continue;
      const phones = telIdx.map(i => cleanPhone(i>=0 ? row[i] : "")).filter(p => p && p!=="0");      let hotline = cleanPhone(hotIdx>=0 ? row[hotIdx] : "");      hotline = (hotline && hotline!=="0") ? hotline : null;
      records.push({        governorate: gov,        provider_type: get(hIdx["التخصص الرئيسي"]),        specialty_sub: get(hIdx["التخصص الفرعي"]),        name: nm,        address: get(hIdx["عنوان مقدم الخدمة"]),        phones,        hotline,        id: `row-${r-1}`      });    }
    // JSON مضغوط كسلسلة    const embeddedJSON = JSON.stringify(records);
    // بلوك الدمج—لا نغير أي سلوك موجود؛ فقط نضيف Getter للوصول للبيانات    const embedBlock =`<!-- ===== Embedded Medical Network Data (inline from Excel) ===== --><script id="network-data" type="application/json">${embeddedJSON}</script><script>  function getEmbeddedNetworkData(){    try { return JSON.parse(document.getElementById('network-data').textContent); }    catch(e){ console.error('Failed to parse embedded network data', e); return []; }  }</script>`;
    // إدراج قبل </body>؛ ولو مش موجودة نضيف في الآخر    let outHTML;    const re = /<\/body>\s*<\/html>\s*$/i;    if (re.test(htmlText)){      outHTML = htmlText.replace(re, embedBlock + "\n</body>\n</html>");    } else {      outHTML = htmlText + "\n" + embedBlock;    }
    // تحميل الملف الناتج    const blob = new Blob([outHTML], {type:"text/html;charset=utf-8"});    const a = document.createElement('a');    a.href = URL.createObjectURL(blob);    a.download = "index_embedded.html";    document.body.appendChild(a);    a.click();    a.remove();    statusEl.innerHTML = "<span class='ok'> تم إنشاء index_embedded.html — جارٍ تنزيله الآن.</span>";
    // ملخص سريع    const kb = (n)=> (n/1024).toFixed(1)+" KB";    logEl.innerHTML = `      <pre>السجلات: ${records.length}حجم البيانات المضمنة (تقريبي): ${kb(embeddedJSON.length)}الشيت المستخدم: ${sheetName}      </pre>`;  } catch(err){    statusEl.innerHTML = "<span class='err'> حدث خطأ: " + (err.message||err) + "</span>";    console.error(err);  }});</script></body></html>
